#!/bin/sh

# only expect tools in this location..
export PATH="/bin:/usr/bin:/usr/local/bin/"

date +'====== %Y-%m-%d %H:%M:%S ======' 1>&2

# make sure we collect the intermediate/ca certs only once for all the different certs
touch -d "yesterday" /tmp/letsencrypt.tmp

{% for item in acme__letsencrypt_certs %}
if [ "{{ acme__config_dir }}/{{ item.file }}" -ot "/tmp/letsencrypt.tmp" ] ; then
    cert=$(ssh "{{ acme__remote_proxy }}" "{{ acme__wrapper }}" get_ca "{{ item.file }}")

    newstartdate=$(echo $cert | openssl x509 -noout -startdate |\
                        cut -d "=" -f2)
    curstartdate=$(openssl x509 -noout -startdate \
                        -in "{{ acme__config_dir }}/{{ item.file }}")

    if [ $(date -d newstartdate +%s) -gt $(date -d curstartdate +%s) ] ; then
        echo $cert > "{{ acme__config_dir }}/{{ item.file }}"
    fi
fi
{% endfor %}

# if the cert is missing (zero-size) or olther then a month
if [ ! -s "{{ acme__certificate }}" ] || [ "{{ acme__certificate }}" -ot "/tmp/letsencrypt.tmp" ] ; then
    # ask for a newly signed cert
    cert=$(ssh "{{ acme__remote_proxy }}" "{{ acme__wrapper }}" get_cert "{{ acme__domain }}")

    newstartdate=$(echo $cert | openssl x509 -noout -startdate |\
                    cut -d "=" -f2)
    curstartdate=$(openssl x509 -noout -startdate \
                    -in "{{ acme__certificate }}")

    if [ $(date -d newstartdate +%s) -gt $(date -d curstartdate +%s) ] ; then
        echo $cert > "{{ acme__certificate }}.crt"

        # install the cert as consumable for the respective services
        cp "{{ acme__certificate }}" "{{ acme__cert_dir }}/{{ acme__cert_name }}.crt"
        cat "{{ acme__certificate }}" {% for item in acme__letsencrypt_certs %}"{{ acme__config_dir }}/{{ item.file }}" {% endfor %} > "{{ acme__cert_dir }}/{{ acme__cert_name }}_chain.crt"
    fi
fi

